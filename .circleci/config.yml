version: 2.1
executors:
  debian11-amd64:
    docker:
      - image: amd64/debian:bullseye
        user: root
  debian11-arm64:
    docker:
      - image: arm64v8/debian:bullseye
        user: root
    resource_class: arm.medium
  debian12-amd64:
    docker:
      - image: amd64/debian:bookworm
        user: root
  debian12-arm64:
    docker:
      - image: arm64v8/debian:bookworm
        user: root
    resource_class: arm.medium

commands:
  setup:
    steps:
      - checkout:
          name: Checkout
      - run:
          name: Create user
          command: useradd build
      - run:
          name: Install dependancies
          command: |
            apt update
            # apt upgrade -y
            apt install -y \
              cmake \
              curl \
              fakeroot \
              fontconfig \
              git \
              gstreamer1.0-alsa \
              gstreamer1.0-libav \
              gstreamer1.0-plugins-bad \
              gstreamer1.0-plugins-base \
              gstreamer1.0-plugins-good \
              gstreamer1.0-plugins-ugly \
              libdrm-dev \
              libegl1-mesa-dev \
              libgbm-dev \
              libgl1-mesa-dev \
              libgles2-mesa-dev \
              libglu1-mesa \
              libgstreamer1.0-dev \
              libgstreamer-plugins-bad1.0-dev \
              libgstreamer-plugins-base1.0-dev \
              libgstreamer1.0-dev \
              libgtk-3-dev \
              libinput-dev \
              liblzma-dev \
              libsystemd-dev \
              libudev-dev \
              libvulkan-dev \
              libxkbcommon-dev \
              m4 \
              ninja-build \
              pkg-config \
              unzip \
              wget \
              xz-utils \
              zip
            apt install -y libstdc++-12-dev || true
            apt install -y libseat-dev || true
      - run:
          name: Setup
          user: build
          command: .circleci/setup
      - store_artifacts:
          path: /tmp/artifacts
jobs:
  debian11-amd64:
    executor: debian11-amd64
    steps:
      - setup
  debian11-arm64:
    executor: debian11-arm64
    steps:
      - setup
  debian12-amd64:
    executor: debian12-amd64
    steps:
      - setup
  debian12-arm64:
    executor: debian12-arm64
    steps:
      - setup

workflows:
  build:
    jobs:
      # - debian11-amd64
      # - debian11-arm64
      - debian12-amd64
      # - debian12-arm64
