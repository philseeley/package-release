version: 2.1
executors:
  debian11-amd64:
    docker:
      - image: amd64/debian:bullseye
    resource_class: medium
  debian11-arm64:
    docker:
      - image: arm64v8/debian:bullseye
    resource_class: arm.medium
  debian12-amd64:
    docker:
      - image: amd64/debian:bookworm
    resource_class: medium
  debian12-arm64:
    docker:
      - image: arm64v8/debian:bookworm
    resource_class: arm.medium
  debian12-arm32:
    docker:
      - image: arm32v7/debian:bookworm
    resource_class: arm.medium

commands:
  dart-arm32:
    steps:
      - run: apt update && apt install -y curl zip
      - run: curl -o dart.zip https://storage.googleapis.com/dart-archive/channels/stable/release/3.5.4/sdk/dartsdk-linux-arm-release.zip
      - run: unzip dart.zip -d /usr/local
      - run: /usr/local/dart-sdk/bin/dart --version
  all:
    steps:
      - run:
          name: Create user
          command: useradd -m build
      - checkout:
          name: Checkout
          path: /home/build/circleci-tesing
      - run:
          name: Install dependancies
          command: |
            apt update
            apt upgrade -y
            apt install -y \
              clang cmake curl fakeroot fontconfig git gstreamer1.0-alsa gstreamer1.0-libav \
              gstreamer1.0-plugins-bad gstreamer1.0-plugins-base gstreamer1.0-plugins-good gstreamer1.0-plugins-ugly \
              libdrm-dev libegl1-mesa-dev libgbm-dev libgl1-mesa-dev libgles2-mesa-dev libglu1-mesa libgstreamer1.0-dev \
              libgstreamer-plugins-bad1.0-dev libgstreamer-plugins-base1.0-dev libgstreamer1.0-dev libgtk-3-dev \
              libinput-dev liblzma-dev libsystemd-dev libudev-dev libvulkan-dev libxkbcommon-dev m4 ninja-build \
              pkg-config unzip wget xz-utils zip
            apt install -y libstdc++-12-dev || true
            apt install -y libseat-dev || true
            apt install -y lib32stdc++6 || true
      - run:
          name: Setup
          command: ${linux32} su - build -c "/home/build/circleci-tesing/.circleci/setup"
      - run:
          name: Package
          command: ${linux32} su - build -c "/home/build/circleci-tesing/.circleci/package ${CPUS}"
      - store_artifacts:
          path: /tmp/artifacts
jobs:
  debian11-amd64:
    executor: debian11-amd64
    environment:
      - CPUS: generic
    steps:
      - all
  debian11-arm64:
    executor: debian11-arm64
    environment:
      - CPUS: generic pi3 pi4
    steps:
      - all
  debian12-amd64:
    executor: debian12-amd64
    environment:
      - CPUS: generic
    steps:
      - all
  debian12-arm64:
    executor: debian12-arm64
    environment:
      - CPUS: generic pi3 pi4
    steps:
      - all
  debian12-arm32:
    executor: debian12-arm32
    environment:
      # - linux32: linux32
      - CPUS: generic pi3 pi4
    steps:
      - dart-arm32
      - all

workflows:
  build:
    jobs:
      # - debian11-amd64
      # - debian11-arm64
      # - debian12-amd64
      # - debian12-arm64
      - debian12-arm32
